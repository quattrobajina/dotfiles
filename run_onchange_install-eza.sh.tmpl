#!/usr/bin/env bash
set -euo pipefail

# --- 
# eza Installation
# --- 
#
# This script is managed by chezmoi as a `run_onchange_` script.
# It automates the download and installation of eza for Linux.
# On other operating systems, it does nothing.
#
# The script's content is dynamically generated by a chezmoi template. A comment
# at the top of this script contains the latest version number fetched from GitHub.
# `chezmoi` will only re-run this script if the version number changes, thus
# avoiding redundant downloads.
#
# --- 

{{ if eq .chezmoi.os "linux" -}}
{{- $api_url := "https://api.github.com/repos/eza-community/eza/releases/latest" -}}
{{- $latest_version := "" -}}
{{- if lookPath "curl" -}}
  {{- $latest_version = output "curl" "--fail" "-sL" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else if lookPath "wget" -}}
  {{- $latest_version = output "wget" "-qO-" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else -}}
  {{ fail "Error: Neither curl nor wget is available for downloading btop version information" }}
{{- end -}}
#
# chezmoi template: Managed by chezmoi
# eza version: {{ $latest_version }}

# Function to log messages
log() {
    echo "â€º $1"
}

# Check for a download tool
if command -v curl >/dev/null 2>&1; then
  DOWNLOAD_CMD="curl --fail -sL"
elif command -v wget >/dev/null 2>&1; then
  DOWNLOAD_CMD="wget -qO-"
else
  log "Error: Neither curl nor wget is installed. Cannot install eza."
  exit 1
fi

log "Installing/updating eza..."

# Determine OS and architecture
OS=$(uname -s)
ARCH=$(uname -m)

case "$OS" in
  Linux) 
    OS_TARGET="unknown-linux-gnu"
    ;;
  *)
    # This should ideally not be reached if chezmoi.os check is correct,
    # but kept as a safeguard.
    log "Error: Unexpected OS ($OS) detected during eza installation."
    exit 1
    ;;
esac

case "$ARCH" in
  x86_64) 
    ARCH_TARGET="x86_64"
    ;;
  aarch64 | arm64) 
    ARCH_TARGET="aarch64"
    ;;
  *)
    log "Error: Unsupported architecture for eza binary download: $ARCH."
    exit 1
    ;;
esac

API_URL="{{ $api_url }}"

log "Fetching download URL..."
DOWNLOAD_URL=$($DOWNLOAD_CMD "$API_URL" | grep "browser_download_url.*${ARCH_TARGET}-${OS_TARGET}" | cut -d '"' -f 4 | head -n 1)

if [ -z "$DOWNLOAD_URL" ]; then
  log "Error: Could not find an eza download URL for your system ($OS / $ARCH)."
  exit 1
fi

TMP_DIR=$(mktemp -d 2>/dev/null || mktemp -d -t 'eza')
trap 'rm -rf "$TMP_DIR"' EXIT

DEST_DIR="$HOME/.local/bin"
mkdir -p "$DEST_DIR"

# Download and extract the release asset, which is a gzipped tarball
log "Downloading from $DOWNLOAD_URL..."
$DOWNLOAD_CMD "$DOWNLOAD_URL" | tar -xz -C "$TMP_DIR"

log "Installing to $DEST_DIR/..."
install -m 755 "$TMP_DIR/eza" "$DEST_DIR/"

log "eza installed/updated successfully."

{{ else -}}
# Not on Linux, skipping eza installation.
exit 0
{{ end -}}
