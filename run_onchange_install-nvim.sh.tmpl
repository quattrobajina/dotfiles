#!/usr/bin/env bash
set -euo pipefail

# --- 
# Neovim Installation
# --- 
#
# This script is managed by chezmoi as a `run_onchange_` script.
# It automates the download and installation of the Neovim AppImage for Linux.
# On other operating systems, it does nothing.
#
# The script's content is dynamically generated by a chezmoi template. A comment
# at the top of this script contains the latest version number fetched from GitHub.
# `chezmoi` will only re-run this script if the version number changes, thus
# avoiding redundant downloads.
#
# --- 

# Function to log messages
log() {
    echo "â€º $1"
}

{{ if eq .chezmoi.os "linux" -}}
{{- $api_url := "https://api.github.com/repos/neovim/neovim/releases/latest" -}}
{{- $latest_version := "" -}}
{{- if lookPath "curl" -}}
  {{- $latest_version = output "curl" "--fail" "-sL" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else if lookPath "wget" -}}
  {{- $latest_version = output "wget" "-qO-" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else -}}
  {{ fail "Error: Neither curl nor wget is available for downloading btop version information" }}
{{- end -}}
#
# chezmoi template: Managed by chezmoi
# nvim version: {{ $latest_version }}

NVIM_INSTALL_PATH="$HOME/.local/bin/nvim"

log "Installing/updating Neovim..."
mkdir -p "$(dirname "$NVIM_INSTALL_PATH")"

# Determine architecture
ARCH_RAW=$(uname -m)
case "$ARCH_RAW" in
    x86_64) 
        ARCH="x86_64"
        ;;
    aarch64 | arm64) 
        ARCH="arm64"
        ;;
    *) 
        log "Error: Unsupported architecture for Neovim AppImage: $ARCH_RAW." >&2
        exit 1
        ;;
esac

# Default to the latest version
version_to_download="latest"

# Workaround for broken arm64 v0.11.5 release
if [ "$ARCH" = "arm64" ] && [ "{{ $latest_version }}" = "v0.11.5" ]; then
    log "Info: Detected arm64 and latest version is v0.11.5. Using v0.11.4 instead."
    version_to_download="v0.11.4"
fi

# Construct the download URL.
# This logic handles two cases:
# 1.  For "latest", it uses the GitHub .../latest/download/... URL structure.
# 2.  For a specific version (like the v0.11.4 workaround), it uses the .../download/<tag>/... structure.
if [ "$version_to_download" = "latest" ]; then
    NVIM_URL="https://github.com/neovim/neovim/releases/latest/download/nvim-linux-${ARCH}.appimage"
else
    NVIM_URL="https://github.com/neovim/neovim/releases/download/${version_to_download}/nvim-linux-${ARCH}.appimage"
fi

log "Downloading from: $NVIM_URL..."

if command -v curl >/dev/null 2>&1; then
    curl --fail -sL "$NVIM_URL" -o "$NVIM_INSTALL_PATH"
elif command -v wget >/dev/null 2>&1; then
    wget -q -O "$NVIM_INSTALL_PATH" "$NVIM_URL"
else
    log "Error: curl or wget is required to download Neovim." >&2
    exit 1
fi

chmod +x "$NVIM_INSTALL_PATH"

log "Neovim installed/updated successfully."

{{ else -}}
# Not on Linux, skipping Neovim installation.
exit 0
{{ end -}}
