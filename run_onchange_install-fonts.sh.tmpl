#!/usr/bin/env bash
set -euo pipefail

# ---
# Font Installation
# ---
#
# This script is managed by chezmoi as a `run_onchange_` script.
# It automates the download and installation of the UDEV Gothic font on macOS.
# On other operating systems, it does nothing.
#
# The script's content is dynamically generated by a chezmoi template. A comment
# at the top of this script contains the latest version number fetched from GitHub.
# `chezmoi` will only re-run this script if the version number changes, thus
# avoiding redundant downloads.
#
# ---

{{ if eq .chezmoi.os "darwin" -}}
{{- $api_url := "https://api.github.com/repos/yuru7/udev-gothic/releases/latest" -}}
{{- $latest_version := "" -}}
{{- if lookPath "curl" -}}
  {{- $latest_version = output "curl" "--fail" "-sL" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else if lookPath "wget" -}}
  {{- $latest_version = output "wget" "-qO-" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else -}}
  {{ fail "Error: Neither curl nor wget is available for downloading btop version information" }}
{{- end -}}
#
# chezmoi template: Managed by chezmoi
# UDEV Gothic version: {{ $latest_version }}

# Define font and download properties
FONT_NAME="UDEV Gothic NFLG"
FONT_DIR="$HOME/Library/Fonts"
API_URL="{{ $api_url }}"
DOWNLOAD_DIR=$(mktemp -d 2>/dev/null || mktemp -d -t 'tmp') # mktemp -d -t for macOS compatibility
ZIP_FILE="$DOWNLOAD_DIR/UDEVGothic.zip"

# Function to log messages
log() {
    echo "â€º $1"
}

# Cleanup function to remove the temporary directory
cleanup() {
    log "Cleaning up..."
    rm -rf "$DOWNLOAD_DIR"
    log "Cleanup complete."
}

# Register the cleanup function to be called on script exit
trap cleanup EXIT

# Check for a download tool
if command -v curl >/dev/null 2>&1; then
  DOWNLOAD_CMD="curl --fail -sL"
elif command -v wget >/dev/null 2>&1; then
  DOWNLOAD_CMD="wget -qO-"
else
  log "Error: Neither curl nor wget is installed. Cannot install eza."
  exit 1
fi

# ---

log "Installing/updating $FONT_NAME..."

# Ensure the font directory exists
mkdir -p "$FONT_DIR"
log "Font directory '$FONT_DIR' is ready."

# Get the download URL for the latest release (Nerd Font version)
log "Fetching download URL..."
FONT_URL=$($DOWNLOAD_CMD "$API_URL" | grep "browser_download_url" | grep "UDEVGothic_NF_v" | sed -E 's/.*"([^"]*)".*/\1/')
if [ -z "$FONT_URL" ]; then
    log "Error: Could not find the download URL for the latest UDEV Gothic Nerd Font release."
    exit 1
fi

# Download the font
log "Downloading from $FONT_URL..."
curl --fail -sL "$FONT_URL" -o "$ZIP_FILE"

# Unzip the font to the fonts directory
log "Installing fonts..."
unzip -j -o "$ZIP_FILE" "UDEVGothic_NF_v*/UDEVGothicNFLG-*.ttf" -d "$FONT_DIR"
log "$FONT_NAME installed/updated successfully."

{{ else -}}
# Not on macOS, skipping font installation.
exit 0
{{ end -}}
