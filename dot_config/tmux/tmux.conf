# --- GENERAL ---
# Set zsh as the default shell
set-option -g default-shell /bin/zsh

# Increase scrollback buffer
set-option -g history-limit 1000000

# Enable mouse support
set-option -g mouse on

# Improve responsiveness by removing escape delay
set-option -g escape-time 0

# Enable OSC52 clipboard integration
set-option -g set-clipboard on


# --- KEY BINDINGS ---
# Use vi keybindings in copy mode
set-window-option -g mode-keys vi

# Mouse wheel scrolls copy mode buffer
bind-key -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind-key -n WheelDownPane select-pane -t= \; send-keys -M

# Key bindings for copy mode (vi style)
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi V send-keys -X select-line
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode-vi Y send-keys -X select-line \; send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel
bind-key -T copy-mode-vi Escape send-keys -X clear-selection


# --- APPEARANCE ---
# Enable 256-color support and True Color
set-option -g default-terminal "tmux-256color"
set-option -ga terminal-overrides ",xterm:RGB,xterm-256color:RGB,screen-256color:RGB,tmux-256color:RGB"

set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # Underline support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m' # Underline color support

# Set pane colors
set-window-option -g window-active-style bg=terminal
set-window-option -g window-style bg=colour234

# Redraw the status bar every second for timely updates
set-option -g status-interval 1

# Status bar content based on OS
# NOTE: This will be overridden by the iceberg.tmux theme, but is kept for fallback.
if-shell "uname | grep -q Darwin" \
    "set-option -g status-right '#{prefix_highlight} | #(wifi) #(battery --tmux) [%Y-%m-%d(%a) %H:%M:%S]'" \
    "set-option -g status-right '#{prefix_highlight} | #{cpu_percentage} #{ram_percentage} | [%Y-%m-%d(%a) %H:%M:%S]'"

# Window status format
set-option -gw window-status-format "#( \ 
  label='#{?window_zoomed_flag,,} #W '; \ 
  bg='#{@c-base-100}'; \ 
  color='#{@c-neutral}'; \ 
  text_fg='#{@c-neutral-content}'; \ 
  if [ \"#{window_bell_flag}\" = \"1\" ]; then \ 
    label=' >> 󱅫 <<#W '; \ 
    color='#{@c-info}'; \ 
    text_fg='#{@c-info-content}'; \ 
  fi; \ 
  echo \"#[bg=$bg,fg=$color]#[bg=$color,fg=$text_fg]$label#[bg=$bg,fg=$color]\"; \ 
)"

# Current window status format
set-option -gw window-status-current-format "#( \ 
  label='#{?window_zoomed_flag,,} #W '; \ 
  bg='#{@c-base-100}'; \ 
  color='#{@c-primary}'; \ 
  text_fg='#{@c-primary-content}'; \ 
  echo \"#[bg=$bg,fg=$color]#[bg=$color,fg=$text_fg,bold]$label#[bg=$bg,fg=$color,nobold]\"; \ 
)"


# --- PLUGINS (TPM) ---
# Set XDG paths for tmux environment, for TPM's internal use
set-environment -g XDG_CONFIG_HOME "$HOME/.config"
set-environment -g TMUX_HOME "$HOME/.config/tmux"
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.local/share/tmux/plugins"

# Auto-install TPM (Tmux Plugin Manager) if not present
# NOTE: Using $HOME directly is more robust than using a variable set moments before.
if-shell "test ! -d $HOME/.local/share/tmux/plugins/tpm" \
    "run \"git clone https://github.com/tmux-plugins/tpm $HOME/.local/share/tmux/plugins/tpm && $HOME/.local/share/tmux/plugins/tpm/bin/install_plugins\""

# List of plugins
set-option -g @plugin 'tmux-plugins/tpm'
set-option -g @plugin 'tmux-plugins/tmux-sensible'
set-option -g @plugin 'tmux-plugins/tmux-prefix-highlight'
set-option -g @plugin '2kabhishek/tmux2k'
set-option -g @plugin 'epszaw/iceberg.tmux'

# --- Theme Configurations ---
# Add custom modules for CPU and RAM to the iceberg theme
set -g @iceberg_cpu_text " #{cpu_percentage}"
set -g @iceberg_ram_text " #{ram_percentage}"

# Prepend the new modules to the right side of the status bar
set -g @iceberg_status_modules_right "cpu ram | host session date_time"


# --- TPM INITIALIZATION ---
# This must be the last line in the configuration
# NOTE: Using $HOME directly is more robust.
run "$HOME/.local/share/tmux/plugins/tpm/tpm"
