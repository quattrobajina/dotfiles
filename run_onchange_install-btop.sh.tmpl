#!/usr/bin/env bash
set -euo pipefail

# ---
# btop Installation
# ---
#
# This script is managed by chezmoi as a `run_onchange_` script.
# It automates the download and installation of btop for Linux.
# On other operating systems, it does nothing.
#
# The script's content is dynamically generated by a chezmoi template. A comment
# at the top of this script contains the latest version number fetched from GitHub.
# `chezmoi` will only re-run this script if the version number changes, thus
# avoiding redundant downloads.
#
# ---

{{ if eq .chezmoi.os "linux" -}}
{{- $api_url := "https://api.github.com/repos/aristocratos/btop/releases/latest" -}}
{{- $latest_version := "" -}}
{{- if lookPath "curl" -}}
  {{- $latest_version = output "curl" "--fail" "-sL" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else if lookPath "wget" -}}
  {{- $latest_version = output "wget" "-qO-" $api_url | regexFind "v[0-9]+\\.[0-9]+\\.[0-9]+" -}}
{{- else -}}
  {{ fail "Error: Neither curl nor wget is available for downloading btop version information" }}
{{- end -}}
#
# chezmoi template: Managed by chezmoi
# btop version: {{ $latest_version }}

# Function to log messages
log() {
    echo "â€º $1"
}

# Check for a download tool
if command -v curl >/dev/null 2>&1; then
  DOWNLOAD_CMD="curl --fail -sL"
elif command -v wget >/dev/null 2>&1; then
  DOWNLOAD_CMD="wget -qO-"
else
  log "Error: Neither curl nor wget is installed. Cannot install btop."
  exit 1
fi

log "Installing/updating btop..."

# Determine architecture
ARCH=$(uname -m)
case "$ARCH" in
  x86_64) 
    ARCH_TARGET="x86_64"
    ;;
  aarch64 | arm64) 
    ARCH_TARGET="aarch64"
    ;;
  *) 
    log "Error: Unsupported architecture for btop binary download: $ARCH."
    exit 1
    ;;
esac

API_URL="{{ $api_url }}"

log "Fetching download URL..."
DOWNLOAD_URL=$($DOWNLOAD_CMD "$API_URL" | grep "browser_download_url.*${ARCH_TARGET}-unknown-linux-musl.tbz" | cut -d '"' -f 4)

if [ -z "$DOWNLOAD_URL" ]; then
  log "Error: Could not find a btop download URL for your system ($ARCH)."
  exit 1
fi

TMP_DIR=$(mktemp -d 2>/dev/null || mktemp -d -t 'btop')
trap 'rm -rf "$TMP_DIR"' EXIT

DEST_DIR="$HOME/.local/bin"
mkdir -p "$DEST_DIR"

# Download and extract the release asset, which is a bzip2-compressed tarball
log "Downloading from $DOWNLOAD_URL..."
$DOWNLOAD_CMD "$DOWNLOAD_URL" | tar -xj -C "$TMP_DIR"

log "Installing to $DEST_DIR/..."
install -m 755 "$TMP_DIR/btop/bin/btop" "$DEST_DIR/"

log "btop installed/updated successfully."

{{ else -}}
# Not on Linux, skipping btop installation.
exit 0
{{ end -}}
